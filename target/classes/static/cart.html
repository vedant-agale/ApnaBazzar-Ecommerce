<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Cart - Apna Bazaar</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f1f3f6; font-family: 'Segoe UI', sans-serif; }
        .navbar { background-color: #2874f0; padding: 15px 30px; color: white; }
        .cart-item { background: white; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: 0.3s; }
        .cart-item:hover { box-shadow: 0 5px 15px rgba(0,0,0,0.15); }
        .product-img { width: 80px; height: 80px; object-fit: contain; }
        .total-card { background: white; border-top: 3px solid #2874f0; }
        .btn-checkout { background-color: #fb641b; color: white; font-weight: bold; border: none; }
        .btn-checkout:hover { background-color: #e65a16; color: white; }
    </style>
</head>
<body>

    <nav class="navbar d-flex justify-content-between">
        <div style="font-size: 24px; font-weight: bold;">üõí Apna Bazaar</div>
        <a href="shop.html" class="btn btn-light btn-sm fw-bold" style="color: #2874f0;">‚Üê Continue Shopping</a>
    </nav>

    <div class="container mt-5">
        <h3 class="mb-4">Your Shopping Cart <span id="userBadge" class="badge bg-warning text-dark fs-6"></span></h3>
        
        <div class="row">
            <div class="col-md-8" id="cart-container">
                <p class="text-center">Loading your cart... ‚è≥</p>
            </div>

            <div class="col-md-4">
                <div class="card p-3 total-card" id="checkout-section" style="display: none;">
                    <h5 class="text-muted border-bottom pb-2">PRICE DETAILS</h5>
                    <div class="d-flex justify-content-between mt-3">
                        <span>Total Price:</span>
                        <h4 class="text-dark">‚Çπ<span id="total-price">0</span></h4>
                    </div>
                    <button onclick="checkout()" class="btn btn-checkout mt-3 w-100 py-2 text-uppercase">Place Order</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. SESSION CHECK ---
        const userJson = localStorage.getItem("loggedInUser");
        if (!userJson) {
            window.location.href = "login.html";
        }
        const currentUser = JSON.parse(userJson);
        const username = currentUser.username; 
        document.getElementById('userBadge').innerText = username;

        // --- 2. LOAD CART ---
        async function loadCart() {
            try {
                const response = await fetch(`http://localhost:8080/api/cart/user/${username}`);
                const cartItems = await response.json();
                renderCart(cartItems);
            } catch (error) {
                document.getElementById('cart-container').innerHTML = '<div class="alert alert-danger">Server error!</div>';
            }
        }

        // --- 3. RENDER ITEMS ---
        function renderCart(items) {
            const container = document.getElementById('cart-container');
            const checkoutSection = document.getElementById('checkout-section');
            let total = 0;

            if (!items || items.length === 0) {
                container.innerHTML = '<div class="card p-5 text-center"><h4>Cart is empty! ‚òπÔ∏è</h4><a href="shop.html" class="btn btn-primary w-50 mx-auto mt-3">Shop Now</a></div>';
                checkoutSection.style.display = 'none';
                return;
            }

            container.innerHTML = items.map(item => {
                total += item.price * item.quantity;
                return `
                <div class="cart-item p-3 mb-3 d-flex align-items-center">
                    <img src="${item.image || 'laptop.jpg'}" class="product-img me-4">
                    <div class="flex-grow-1">
                        <h5 class="mb-1">${item.productName}</h5>
                        <p class="text-primary fw-bold mb-0">‚Çπ${item.price}</p>
                    </div>
                    <button onclick="removeItem(${item.id})" class="btn text-danger btn-sm fw-bold">REMOVE</button>
                </div>`;
            }).join('');

            document.getElementById('total-price').innerText = total.toLocaleString();
            checkoutSection.style.display = 'block';
        }

        // --- 4. REMOVE SINGLE ITEM ---
        async function removeItem(cartId) {
            if(!confirm("Remove karein?")) return;
            const response = await fetch(`http://localhost:8080/api/cart/${cartId}`, { method: 'DELETE' });
            if (response.ok) loadCart();
        }

        // --- 5. ASLI CHECKOUT LOGIC (NEW) ---
        async function checkout() {
            if (!confirm("Order Confirm Karein?")) return;

            try {
                // Backend ke 'place order' endpoint ko call karein
                const response = await fetch(`http://localhost:8080/api/orders/place/${username}`, {
                    method: 'POST'
                });

                if (response.ok) {
                    const msg = await response.text();
                    alert(msg); // "Mubarak ho! Order place ho gaya hai."
                    window.location.href = "orders.html"; // Naye page par bhejein
                } else {
                    alert("Order fail ho gaya! Cart check karein.");
                }
            } catch (error) {
                alert("Server down hai! üõ†Ô∏è");
            }
        }

        loadCart();
    </script>
</body>
</html>