<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Apna Bazaar - Shop</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f1f3f6; margin: 0; }
        .navbar { background-color: #2874f0; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; color: white; }
        .logo { font-size: 24px; font-weight: bold; }
        #welcomeMsg { font-size: 16px; font-weight: bold; color: #ffe500; }
        .cart-btn { background-color: white; color: #2874f0; border: none; padding: 10px 20px; font-weight: bold; cursor: pointer; border-radius: 2px; }
        .product-container { display: flex; flex-wrap: wrap; justify-content: center; padding: 20px; gap: 20px; }
        .card { background: white; width: 250px; padding: 20px; border-radius: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center; }
        .card img { width: 100%; height: 200px; object-fit: contain; }
        .btn-buy { background-color: #ff9f00; color: white; border: none; padding: 12px 20px; width: 100%; font-weight: bold; cursor: pointer; border-radius: 2px; }
    </style>
</head>
<body>

    <div class="navbar">
        <div class="logo">üõí Apna Bazaar</div>
        <div id="welcomeMsg">Welcome, Guest</div>
        <div> 
            <button class="cart-btn" onclick="window.location.href='cart.html'" id="cartCountBtn">Cart (0)</button>
            <button onclick="logout()" style="background:none; border:none; color:white; cursor:pointer; margin-left:10px;">Logout</button>
        </div>
    </div>

    <div class="product-container" id="productList"></div>

    <script>
        const API_BASE = "http://localhost:8080/api";

        document.addEventListener("DOMContentLoaded", () => {
            const userJson = localStorage.getItem("loggedInUser");
            if (!userJson) {
                window.location.href = "login.html";
                return;
            }

            const user = JSON.parse(userJson);
            // Updating the welcome message
            document.getElementById("welcomeMsg").innerText = "Welcome, " + user.username + " üëã";
            
            loadProducts();
            updateCartCount(user.username);
        });

        async function loadProducts() {
            try {
                const response = await fetch(API_BASE + "/products");
                const products = await response.json();
                const container = document.getElementById("productList");
                container.innerHTML = products.map(p => `
                    <div class="card">
                        <img src="${p.image}" alt="${p.name}">
                        <div style="font-weight:500; margin-top:10px;">${p.name}</div>
                        <div style="font-weight:bold; margin:10px 0;">‚Çπ${p.price}</div>
                        <button class="btn-buy" onclick="addToCart('${p.name}', ${p.price}, '${p.image}')">ADD TO CART üõçÔ∏è</button>
                    </div>
                `).join('');
            } catch (error) { console.error("Error loading products", error); }
        }

        async function addToCart(name, price, image) {
            const user = JSON.parse(localStorage.getItem("loggedInUser"));
            const cartItem = { productName: name, price: price, image: image, quantity: 1, username: user.username };

            try {
                const response = await fetch(API_BASE + "/cart/add", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(cartItem)
                });
                if (response.ok) {
                    alert(name + " added to cart! üéâ");
                    updateCartCount(user.username);
                }
            } catch (e) { alert("Server connectivity issue!"); }
        }

        async function updateCartCount(username) {
            const response = await fetch(API_BASE + "/cart/user/" + username);
            const items = await response.json();
            document.getElementById("cartCountBtn").innerText = "Cart (" + items.length + ")";
        }

        function logout() {
    // 1. Browser memory se user data delete karein
    localStorage.removeItem("loggedInUser");
    
    // 2. Wapas login page par bhej dein
    alert("Aap safely log out ho gaye hain. Fir milenge! üëã");
    window.location.href = "login.html";
}
    </script>
</body>
</html>